<!DOCTYPE html>
<html>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/css/email_challenge.css" rel="stylesheet">
<style>
    h1 {
        letter-spacing: -1px;
		font-weight: 900;
		font-size: 28px;
		line-height: 1.2143;
		color: #1d1c1d;
		margin: 4px 0 20px 0
    }

	.p1 {
		font-size: 15px;
		line-height: 1.46668;
		color: #1d1c1d;
		margin-bottom: 32px;
	}

	.p2 {
		font-size: 13px;
		font-weight: 400;
		line-height: 1.38463;
		text-align: left;
		color: #1d1c1d;
		margin-bottom: 32px;
		margin-top: 32px;
	}

    .success,
    .error {
		font-size: 13px;
		font-weight: 400;
		line-height: 1.38463;
		text-align: left;
		margin-bottom: 32px;
		margin-top: 32px;
    }

    .code {
        display: flex;
        font-weight: 400;
        font-size: 15px;
        max-width: 600px;
		margin: 25px auto 0;
    }

    .code_input {
        margin: 0;
        padding: 0 10px;
        text-align: center;
        border: solid 1px #616061;
        border-color: rgba(29,28,29,.5);
        border-radius: 0px;
		line-height: 60px;
		font-size: 22px;
		outline: none;
        width: 15%;
		max-width: 60px;
		transition: all 0.2s ease-in-out;
        text-transform: uppercase;
        display: inline-block;
    }

	.code_input:focus {
		border:1px solid #1264a3;
		box-shadow: 0 0 7px rgba(18,100,163,.3);
	}

	.code_input::selection {
		background: transparent;
	}

    .code_input_middle {
        border-left: none;
    }

    .code_input_left {
        border-bottom-left-radius: 4px;
        border-top-left-radius: 4px;
    }

    .code_input_right {
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
    }
</style>

<body>
    <div class="main">
        <div class="container">
            <h1>Check your email!</h1>
            <p class="p1">
                We've sent a 6-alphanumeric confirmation code to 
                <strong>${email}</strong>. It will expire shortly, so enter it soon.
            </p>

            <div class="code">
                <input type="text" name="code[1]" aria-label autocomplete="off" class="code_input code_input_left">
                <input type="text" name="code[2]" aria-label autocomplete="off" class="code_input code_input_middle">
                <input type="text" name="code[3]" aria-label autocomplete="off" class="code_input code_input_right code_input_middle">
                <div style="align-self: center; margin: 0 6px;"> â€” </div>
                <input type="text" name="code[4]" aria-label autocomplete="off" class="code_input code_input_left">
                <input type="text" name="code[5]" aria-label autocomplete="off" class="code_input code_input_middle">
                <input type="text" name="code[6]" aria-label autocomplete="off" class="code_input code_input_right code_input_middle">
            </div>

            <form id="verify_form" tal:attributes="action url" method="POST">
                <div style="display: none;">
                    <input type="text" name="name" value="${name}" />
                    <input type="text" name="email" value="${email}" />
                    <input type="text" name="code" id="code" />
                    <input type="text" id="code_prefix" value="${code_prefix}" />
                </div>

                <p class="success " style="display:none;"></p>
                <p class="error" style="display:none;"></p>
                <div class="spinnerText" style="display:none;">
                    <span class="spinner-border" role="status" aria-hidden="true" style="width:19px;height:19px; border-width:3px; margin-right:4px;"></span>Verifying...
                </div>
            </form>

            <p id="info" class="p2">
                Keep this window open while checking for your code. Remember to try your spam folder!
            </p>
        </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
<script src="/static/js/base.js"></script>
<script>

    function getIndex($input) {
        return parseInt($input.attr('name').split(/[\[\]]/)[1], 10);
    }

    function handleCodeInput(event) {
        var $input = $(this),
            index = getIndex($input),
            digit = $input.val().slice(0,1),
            rest = $input.val().slice(1),
            $next;

        if (rest.length > 0) {
            $input.val(digit);
            $next = $('.code_input[name="code['+ (index + 1) +']"]');

            if ($next.length > 0 && index < 6) {
                $next.val(rest);  // push the rest of the value into the next input
                $next.focus();
                handleCodeInput.call($next, event);  // run the same code on the next input
            }
        } else if (digit && index < 6) {
            $next = $('.code_input[name="code['+ (index + 1) +']"]');
            $next.focus();
        }
    }

    function handleInput(event) {
        var value = $(this).val();
        $(this).val(value.replace(/[^a-z0-9]/gi,''));
        handleCodeInput.call($(this), event);
        if ($(this).val()) {
            codeInput();
        }
    }

    function handleBackspace(event) {
        var $input = $(this),
            index = getIndex($input),
            $prev;

        // if the user pressed backspace and the input is empty
        if (event.which === 8 && !$(this).val()) {
            $prev = $('.code_input[name="code['+ (index - 1) +']"]');
            $prev.focus();
        }
    }

    $('.code_input').on('input', handleInput)
                    .on('keydown', handleBackspace);

    function codeInput() {
        var value = document.getElementById('code_prefix').value;
        var items = document.getElementsByClassName('code_input');
        for (i = 0; i < items.length; i++) {
            value = value + items[i].value;
        }
        var code = document.getElementById("code");
        code.value = value;

        if (value.length == 12) {
            verifyCode();
        }
    }

    function verifyCode() {
        clearMessages();
        var form = $('#verify_form');
        var url = $(form).attr('action');
        var name = $(form.find('input[name="name"]')[0]).val();
        var email = $(form.find('input[name="email"]')[0]).val();
        var code = $(form.find('input[name="code"]')[0]).val();
        var data = {'name': name,
                    'email': email,
                    'code': code};

        var spinner = $(form).find('.spinnerText')[0];
        $(spinner).show();

        $('#info').hide();

        $.ajax({
            url: url,
            method: 'POST',
            data: data,
            success: function (result) {
                $(spinner).hide();
                showSuccessMessage("Verified!");
            },
            error: function (xhr, exception) {
                $(spinner).hide();
                var result = JSON.parse(xhr.responseText);
                showErrorMessage(result['message'], '.success', '.error');
            }
        });
    }
</script>
</html>
